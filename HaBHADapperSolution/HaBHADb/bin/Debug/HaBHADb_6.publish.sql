/*
Deployment script for HaBHADb

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "HaBHADb"
:setvar DefaultFilePrefix "HaBHADb"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL16.SQLEXPRESS02\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL16.SQLEXPRESS02\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
/*
The type for column AmenityId in table [dbo].[Amenities] is currently  UNIQUEIDENTIFIER NOT NULL but is being changed to  INT IDENTITY (1, 1) NOT NULL. There is no implicit or explicit conversion.

The type for column BoardinghouseId in table [dbo].[Amenities] is currently  UNIQUEIDENTIFIER NULL but is being changed to  INT NULL. There is no implicit or explicit conversion.
*/

IF EXISTS (select top 1 1 from [dbo].[Amenities])
    RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
/*
The type for column BoardinghouseId in table [dbo].[BoardingHouses] is currently  UNIQUEIDENTIFIER NOT NULL but is being changed to  INT IDENTITY (1, 1) NOT NULL. There is no implicit or explicit conversion.
*/

IF EXISTS (select top 1 1 from [dbo].[BoardingHouses])
    RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
/*
The type for column BoardingHouseId in table [dbo].[BookingTransactions] is currently  UNIQUEIDENTIFIER NULL but is being changed to  INT NULL. There is no implicit or explicit conversion.

The type for column BookingTransactionId in table [dbo].[BookingTransactions] is currently  UNIQUEIDENTIFIER NOT NULL but is being changed to  INT IDENTITY (1, 1) NOT NULL. There is no implicit or explicit conversion.
*/

IF EXISTS (select top 1 1 from [dbo].[BookingTransactions])
    RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
/*
The type for column BoardinghouseId in table [dbo].[ClientRequests] is currently  UNIQUEIDENTIFIER NULL but is being changed to  INT NULL. There is no implicit or explicit conversion.

The type for column ClientRequestId in table [dbo].[ClientRequests] is currently  UNIQUEIDENTIFIER NOT NULL but is being changed to  INT IDENTITY (1, 1) NOT NULL. There is no implicit or explicit conversion.
*/

IF EXISTS (select top 1 1 from [dbo].[ClientRequests])
    RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
/*
The type for column BoardinghouseId in table [dbo].[Images] is currently  UNIQUEIDENTIFIER NULL but is being changed to  INT NULL. There is no implicit or explicit conversion.
*/

IF EXISTS (select top 1 1 from [dbo].[Images])
    RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
PRINT N'Dropping Default Constraint unnamed constraint on [dbo].[Amenities]...';


GO
ALTER TABLE [dbo].[Amenities] DROP CONSTRAINT [DF__Amenities__Ameni__628FA481];


GO
PRINT N'Dropping Default Constraint unnamed constraint on [dbo].[BoardingHouses]...';


GO
ALTER TABLE [dbo].[BoardingHouses] DROP CONSTRAINT [DF__BoardingH__Board__6477ECF3];


GO
PRINT N'Dropping Default Constraint unnamed constraint on [dbo].[BookingTransactions]...';


GO
ALTER TABLE [dbo].[BookingTransactions] DROP CONSTRAINT [DF__BookingTr__Booki__656C112C];


GO
PRINT N'Dropping Default Constraint unnamed constraint on [dbo].[BookingTransactions]...';


GO
ALTER TABLE [dbo].[BookingTransactions] DROP CONSTRAINT [DF__BookingTr__Statu__66603565];


GO
PRINT N'Dropping Default Constraint unnamed constraint on [dbo].[ClientRequests]...';


GO
ALTER TABLE [dbo].[ClientRequests] DROP CONSTRAINT [DF__ClientReq__Clien__6754599E];


GO
PRINT N'Dropping Default Constraint unnamed constraint on [dbo].[ClientRequests]...';


GO
ALTER TABLE [dbo].[ClientRequests] DROP CONSTRAINT [DF__ClientReq__Reque__68487DD7];


GO
PRINT N'Dropping Default Constraint unnamed constraint on [dbo].[ClientRequests]...';


GO
ALTER TABLE [dbo].[ClientRequests] DROP CONSTRAINT [DF__ClientReq__Statu__693CA210];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_Amenities_BoardingHouses_BoardinghouseId]...';


GO
ALTER TABLE [dbo].[Amenities] DROP CONSTRAINT [FK_Amenities_BoardingHouses_BoardinghouseId];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_BoardingHouses_AspNetUsers_TenantId]...';


GO
ALTER TABLE [dbo].[BoardingHouses] DROP CONSTRAINT [FK_BoardingHouses_AspNetUsers_TenantId];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_BookingTransactions_BoardingHouses_BoardingHouseId]...';


GO
ALTER TABLE [dbo].[BookingTransactions] DROP CONSTRAINT [FK_BookingTransactions_BoardingHouses_BoardingHouseId];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_ClientRequests_BoardingHouses]...';


GO
ALTER TABLE [dbo].[ClientRequests] DROP CONSTRAINT [FK_ClientRequests_BoardingHouses];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_Images_Boardinghouse]...';


GO
ALTER TABLE [dbo].[Images] DROP CONSTRAINT [FK_Images_Boardinghouse];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_BookingTransactions_AspNetUsers_ClientId]...';


GO
ALTER TABLE [dbo].[BookingTransactions] DROP CONSTRAINT [FK_BookingTransactions_AspNetUsers_ClientId];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_ClientRequests_AspNetUsers_ClientId]...';


GO
ALTER TABLE [dbo].[ClientRequests] DROP CONSTRAINT [FK_ClientRequests_AspNetUsers_ClientId];


GO
PRINT N'Starting rebuilding table [dbo].[Amenities]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Amenities] (
    [AmenityId]       INT             IDENTITY (1, 1) NOT NULL,
    [BoardinghouseId] INT             NULL,
    [Name]            NVARCHAR (255)  NOT NULL,
    [Price]           DECIMAL (18, 2) NULL,
    CONSTRAINT [tmp_ms_xx_constraint_PK_Amenities1] PRIMARY KEY CLUSTERED ([AmenityId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Amenities])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Amenities] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Amenities] ([AmenityId], [BoardinghouseId], [Name], [Price])
        SELECT   [AmenityId],
                 [BoardinghouseId],
                 [Name],
                 [Price]
        FROM     [dbo].[Amenities]
        ORDER BY [AmenityId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Amenities] OFF;
    END

DROP TABLE [dbo].[Amenities];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Amenities]', N'Amenities';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_PK_Amenities1]', N'PK_Amenities', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating Index [dbo].[Amenities].[IX_Amenities_BoardinghouseId]...';


GO
CREATE NONCLUSTERED INDEX [IX_Amenities_BoardinghouseId]
    ON [dbo].[Amenities]([BoardinghouseId] ASC);


GO
PRINT N'Starting rebuilding table [dbo].[BoardingHouses]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_BoardingHouses] (
    [BoardinghouseId] INT             IDENTITY (1, 1) NOT NULL,
    [RoomNumber]      INT             NULL,
    [RoomSize]        INT             NULL,
    [PricePerMonth]   DECIMAL (18, 2) NULL,
    [IsAvailble]      BIT             NOT NULL,
    [Descriptions]    NVARCHAR (MAX)  NULL,
    [TenantId]        NVARCHAR (450)  NULL,
    [ClientId]        NVARCHAR (450)  NULL,
    CONSTRAINT [tmp_ms_xx_constraint_PK_BoardingHouses1] PRIMARY KEY CLUSTERED ([BoardinghouseId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[BoardingHouses])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_BoardingHouses] ON;
        INSERT INTO [dbo].[tmp_ms_xx_BoardingHouses] ([BoardinghouseId], [RoomNumber], [RoomSize], [PricePerMonth], [IsAvailble], [Descriptions], [TenantId], [ClientId])
        SELECT   [BoardinghouseId],
                 [RoomNumber],
                 [RoomSize],
                 [PricePerMonth],
                 [IsAvailble],
                 [Descriptions],
                 [TenantId],
                 [ClientId]
        FROM     [dbo].[BoardingHouses]
        ORDER BY [BoardinghouseId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_BoardingHouses] OFF;
    END

DROP TABLE [dbo].[BoardingHouses];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_BoardingHouses]', N'BoardingHouses';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_PK_BoardingHouses1]', N'PK_BoardingHouses', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating Index [dbo].[BoardingHouses].[IX_BoardingHouses_TenantId]...';


GO
CREATE NONCLUSTERED INDEX [IX_BoardingHouses_TenantId]
    ON [dbo].[BoardingHouses]([TenantId] ASC);


GO
PRINT N'Starting rebuilding table [dbo].[BookingTransactions]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_BookingTransactions] (
    [BookingTransactionId] INT             IDENTITY (1, 1) NOT NULL,
    [BoardingHouseId]      INT             NULL,
    [ClientId]             NVARCHAR (450)  NOT NULL,
    [BookingDate]          DATETIME        NOT NULL,
    [CheckInDate]          DATETIME        NULL,
    [CheckOutDate]         DATETIME        NULL,
    [Status]               NVARCHAR (50)   DEFAULT ('Pending') NOT NULL,
    [AmountPaid]           DECIMAL (18, 2) NULL,
    CONSTRAINT [tmp_ms_xx_constraint_PK_BookingTransactions1] PRIMARY KEY CLUSTERED ([BookingTransactionId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[BookingTransactions])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_BookingTransactions] ON;
        INSERT INTO [dbo].[tmp_ms_xx_BookingTransactions] ([BookingTransactionId], [BoardingHouseId], [ClientId], [BookingDate], [CheckInDate], [CheckOutDate], [Status], [AmountPaid])
        SELECT   [BookingTransactionId],
                 [BoardingHouseId],
                 [ClientId],
                 [BookingDate],
                 [CheckInDate],
                 [CheckOutDate],
                 [Status],
                 [AmountPaid]
        FROM     [dbo].[BookingTransactions]
        ORDER BY [BookingTransactionId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_BookingTransactions] OFF;
    END

DROP TABLE [dbo].[BookingTransactions];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_BookingTransactions]', N'BookingTransactions';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_PK_BookingTransactions1]', N'PK_BookingTransactions', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating Index [dbo].[BookingTransactions].[IX_BookingTransactions_BoardingHouseId]...';


GO
CREATE NONCLUSTERED INDEX [IX_BookingTransactions_BoardingHouseId]
    ON [dbo].[BookingTransactions]([BoardingHouseId] ASC);


GO
PRINT N'Creating Index [dbo].[BookingTransactions].[IX_BookingTransactions_ClientId]...';


GO
CREATE NONCLUSTERED INDEX [IX_BookingTransactions_ClientId]
    ON [dbo].[BookingTransactions]([ClientId] ASC);


GO
PRINT N'Starting rebuilding table [dbo].[ClientRequests]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_ClientRequests] (
    [ClientRequestId] INT            IDENTITY (1, 1) NOT NULL,
    [BoardinghouseId] INT            NULL,
    [ClientId]        NVARCHAR (450) NOT NULL,
    [RequestDate]     DATETIME       DEFAULT (getdate()) NOT NULL,
    [Status]          NVARCHAR (50)  DEFAULT ('Pending') NOT NULL,
    [Message]         NVARCHAR (MAX) NULL,
    PRIMARY KEY CLUSTERED ([ClientRequestId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[ClientRequests])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_ClientRequests] ON;
        INSERT INTO [dbo].[tmp_ms_xx_ClientRequests] ([ClientRequestId], [BoardinghouseId], [ClientId], [RequestDate], [Status], [Message])
        SELECT   [ClientRequestId],
                 [BoardinghouseId],
                 [ClientId],
                 [RequestDate],
                 [Status],
                 [Message]
        FROM     [dbo].[ClientRequests]
        ORDER BY [ClientRequestId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_ClientRequests] OFF;
    END

DROP TABLE [dbo].[ClientRequests];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_ClientRequests]', N'ClientRequests';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating Index [dbo].[ClientRequests].[IX_ClientRequests_BoardinghouseId]...';


GO
CREATE NONCLUSTERED INDEX [IX_ClientRequests_BoardinghouseId]
    ON [dbo].[ClientRequests]([BoardinghouseId] ASC);


GO
PRINT N'Creating Index [dbo].[ClientRequests].[IX_ClientRequests_ClientId]...';


GO
CREATE NONCLUSTERED INDEX [IX_ClientRequests_ClientId]
    ON [dbo].[ClientRequests]([ClientId] ASC);


GO
PRINT N'Starting rebuilding table [dbo].[Images]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Images] (
    [ImageId]         INT             IDENTITY (1, 1) NOT NULL,
    [FileName]        NVARCHAR (255)  NULL,
    [ContentType]     NVARCHAR (100)  NULL,
    [ImageData]       VARBINARY (MAX) NULL,
    [BoardinghouseId] INT             NULL,
    PRIMARY KEY CLUSTERED ([ImageId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Images])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Images] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Images] ([ImageId], [FileName], [ContentType], [ImageData], [BoardinghouseId])
        SELECT   [ImageId],
                 [FileName],
                 [ContentType],
                 [ImageData],
                 [BoardinghouseId]
        FROM     [dbo].[Images]
        ORDER BY [ImageId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Images] OFF;
    END

DROP TABLE [dbo].[Images];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Images]', N'Images';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating Foreign Key [dbo].[FK_Amenities_BoardingHouses_BoardinghouseId]...';


GO
ALTER TABLE [dbo].[Amenities] WITH NOCHECK
    ADD CONSTRAINT [FK_Amenities_BoardingHouses_BoardinghouseId] FOREIGN KEY ([BoardinghouseId]) REFERENCES [dbo].[BoardingHouses] ([BoardinghouseId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_BoardingHouses_AspNetUsers_TenantId]...';


GO
ALTER TABLE [dbo].[BoardingHouses] WITH NOCHECK
    ADD CONSTRAINT [FK_BoardingHouses_AspNetUsers_TenantId] FOREIGN KEY ([TenantId]) REFERENCES [dbo].[AspNetUsers] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_BookingTransactions_BoardingHouses_BoardingHouseId]...';


GO
ALTER TABLE [dbo].[BookingTransactions] WITH NOCHECK
    ADD CONSTRAINT [FK_BookingTransactions_BoardingHouses_BoardingHouseId] FOREIGN KEY ([BoardingHouseId]) REFERENCES [dbo].[BoardingHouses] ([BoardinghouseId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_ClientRequests_BoardingHouses]...';


GO
ALTER TABLE [dbo].[ClientRequests] WITH NOCHECK
    ADD CONSTRAINT [FK_ClientRequests_BoardingHouses] FOREIGN KEY ([BoardinghouseId]) REFERENCES [dbo].[BoardingHouses] ([BoardinghouseId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_Images_Boardinghouse]...';


GO
ALTER TABLE [dbo].[Images] WITH NOCHECK
    ADD CONSTRAINT [FK_Images_Boardinghouse] FOREIGN KEY ([BoardinghouseId]) REFERENCES [dbo].[BoardingHouses] ([BoardinghouseId]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_BookingTransactions_AspNetUsers_ClientId]...';


GO
ALTER TABLE [dbo].[BookingTransactions] WITH NOCHECK
    ADD CONSTRAINT [FK_BookingTransactions_AspNetUsers_ClientId] FOREIGN KEY ([ClientId]) REFERENCES [dbo].[AspNetUsers] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_ClientRequests_AspNetUsers_ClientId]...';


GO
ALTER TABLE [dbo].[ClientRequests] WITH NOCHECK
    ADD CONSTRAINT [FK_ClientRequests_AspNetUsers_ClientId] FOREIGN KEY ([ClientId]) REFERENCES [dbo].[AspNetUsers] ([Id]);


GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[Amenities] WITH CHECK CHECK CONSTRAINT [FK_Amenities_BoardingHouses_BoardinghouseId];

ALTER TABLE [dbo].[BoardingHouses] WITH CHECK CHECK CONSTRAINT [FK_BoardingHouses_AspNetUsers_TenantId];

ALTER TABLE [dbo].[BookingTransactions] WITH CHECK CHECK CONSTRAINT [FK_BookingTransactions_BoardingHouses_BoardingHouseId];

ALTER TABLE [dbo].[ClientRequests] WITH CHECK CHECK CONSTRAINT [FK_ClientRequests_BoardingHouses];

ALTER TABLE [dbo].[Images] WITH CHECK CHECK CONSTRAINT [FK_Images_Boardinghouse];

ALTER TABLE [dbo].[BookingTransactions] WITH CHECK CHECK CONSTRAINT [FK_BookingTransactions_AspNetUsers_ClientId];

ALTER TABLE [dbo].[ClientRequests] WITH CHECK CHECK CONSTRAINT [FK_ClientRequests_AspNetUsers_ClientId];


GO
PRINT N'Update complete.';


GO
